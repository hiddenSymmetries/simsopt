BootStrap: docker
From: ubuntu:20.04 # hiddensymmetries/simsopt:latest
Stage: devel

%post
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive  apt-get install -y  build-essential gfortran git m4 wget cmake \
    openmpi-bin libopenmpi-dev libscalapack-dev \
    libopenblas-dev libfftw3-dev libhdf5-dev libhdf5-serial-dev libnetcdf-dev libnetcdff-dev libgl1-mesa-dev \
    python3-dev python3-pip python3-venv

    python3 -m venv /venv/

    /venv/bin/pip install -U pip
    /venv/bin/python -m pip install numpy scipy jax jaxlib f90nml mpi4py jupyter notebook ipython qsc sympy scikit-build ninja "pybind11[global]" cmake
    /venv/bin/pip install git+https://github.com/zhucaoxiang/f90wrap
    PATH="/venv/bin:${PATH}"

    git clone --depth 1 https://github.com/PrincetonUniversity/SPEC.git /src/SPEC && \
    cd /src/SPEC   &&  \
    /venv/bin/python setup.py bdist_wheel && \
    /venv/bin/pip install -v dist/*.whl

    git clone --depth 1 https://github.com/hiddenSymmetries/VMEC2000.git /src/VMEC && \
    cd /src/VMEC && \
    cp cmake/machines/ubuntu.json cmake_config_file.json && \
    /venv/bin/pip install  .

    /venv/bin/pip install h5py pyoculus py_spec
    /venv/bin/pip install vtk==9.0.1 pyqt5 matplotlib pyevtk plotly
    /venv/bin/pip install mayavi
    /venv/bin/pip install  git+https://github.com/hiddenSymmetries/booz_xform

    CI=True
    git clone --recurse-submodules https://github.com/hiddenSymmetries/simsopt.git /src/simsopt && \
    cd /src/simsopt && \
    git fetch --tags --all && \
    /venv/bin/pip install  -v .



BootStrap: library
From: ubuntu:20.04
Stage: final

%post
    apt update && \
    DEBIAN_FRONTEND=noninteractive  apt-get install -y m4 vim emacs nano git wget \
    libfftw3-dev  libopenblas-dev libhdf5-serial-dev libnetcdf-dev libnetcdff-dev libgl1-mesa-dev \
    python3-dev python3-venv

%files from devel
     /venv /venv

%startscript
     . /venv/bin/activate

%labels
      maintainer.name "Bharat Medasani"
      maintainer.email "mbkumar@gmail.com"
      developers "Hidden Symmetries Team"
      version "0.07"
      description  "Singularity container for simsopt built on Ubuntu 20.04"

%help
    This is a simsopt singularity container. 

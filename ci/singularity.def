BootStrap: docker
From: ubuntu:20.04 # hiddensymmetries/simsopt:latest
Stage: devel

%post
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive  apt-get install -y  build-essential gfortran git m4 wget cmake \
    libhwloc-dev libpmix-dev \
    libopenblas-dev libfftw3-dev libhdf5-dev libhdf5-serial-dev libnetcdf-dev libnetcdff-dev libgl1-mesa-dev \
    python3-dev python3-pip python3-venv

    # Install openmpi manually
    #-------------------------
    OMPI_VER=4.1.0
    OMPI_PRE=openmpi-${OMPI_VER}
    wget https://download.open-mpi.org/release/open-mpi/v4.1/${OMPI_PRE}.tar.bz2 && \
    tar xvjf ${OMPI_PRE}.tar.bz2  && \
    cd ${OMP_PRE}           && \
    ./configure --enable-mpi-fortran  --enable-mpi-cxx   --enable-shared --disable-static --with-pmix --with-pmix-libdir=/usr/lib/x86_64-linux-gnu/pmix/lib --with-hwloc --with-hwloc-libdir=/usr/lib/x86_64-linux-gnu                     && \
    make -j 4                       && \
    make install                    && \
    make clean                      && \
    cd ..                           && \
    rm -rf openmpi-${OMPI_VER}      && \
    /sbin/ldconfig

    git clone --depth 1 https://github.com/Reference-ScaLAPACK/scalapack.git && \
    cd scalapack && \
    CC=mpicc F77=mpif77 FC=mpif90 CXX=mpicxx cmake -DBUILD_SHARED_LIBS=ON -S . -B build && \
    cd build && \
    make -j 4 && \
    cmake --install . && \
    cd ../..  && \
    rm -rf scalapack && \
    /sbin/ldconfig

    python3 -m venv /venv/
    /venv/bin/pip install -U pip
    /venv/bin/python -m pip install numpy scipy jax jaxlib f90nml mpi4py jupyter notebook ipython qsc sympy scikit-build ninja "pybind11[global]" cmake
    /venv/bin/pip install git+https://github.com/zhucaoxiang/f90wrap
    PATH="/venv/bin:${PATH}"

    git clone --depth 1 https://github.com/PrincetonUniversity/SPEC.git && \
    cd SPEC   &&  \
    /venv/bin/python setup.py bdist_wheel && \
    /venv/bin/pip install -v dist/*.whl

    git clone --depth 1 https://github.com/hiddenSymmetries/VMEC2000.git && \
    cd VMEC && \
    cp cmake/machines/ubuntu.json cmake_config_file.json && \
    /venv/bin/pip install  .

    /venv/bin/pip install h5py pyoculus py_spec
    /venv/bin/pip install vtk==9.0.1 pyqt5 matplotlib pyevtk plotly
    /venv/bin/pip install mayavi
    /venv/bin/pip install  git+https://github.com/hiddenSymmetries/booz_xform

    CI=True
    git clone --recurse-submodules https://github.com/hiddenSymmetries/simsopt.git /src/simsopt && \
    cd /src/simsopt && \
    git fetch --tags --all && \
    /venv/bin/pip install  -v .



BootStrap: library
From: ubuntu:20.04
Stage: final

%files from devel
    /venv /venv
    /usr/local /usr/local

%post
    apt update && \
    DEBIAN_FRONTEND=noninteractive  apt-get install -y m4 vim emacs nano git wget \
    libhwloc-dev libpmix-dev \
    libfftw3-dev  libopenblas-dev libhdf5-serial-dev libnetcdf-dev libnetcdff-dev libgl1-mesa-dev \
    python3-dev python3-venv && \
    /sbin/ldconfig

%startscript
    . /venv/bin/activate

%labels
    maintainer.name "Bharat Medasani"
    maintainer.email "mbkumar@gmail.com"
    developers "Hidden Symmetries Team"
    version "0.07"
    description  "Singularity container for simsopt built on Ubuntu 20.04"

%help
    This is a simsopt singularity container. 
